---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
	const blogEntries = await getCollection('blog');
	return Promise.all(
		blogEntries.map(async (entry) => {
			const { Content } = await entry.render();
			return {
				params: { slug: entry.slug },
				props: {
					entry,
					Content,
				},
			};
		})
	);
}

const { slug } = Astro.params;
const { entry, Content } = Astro.props;
const siteURL = 'https://yensaopremium.com';
const post = entry ? {
	id: entry.id,
	title: entry.data.title,
	slug: entry.slug,
	excerpt: entry.data.excerpt,
	author: entry.data.author,
	publishedAt: entry.data.publishedAt,
	updatedAt: entry.data.updatedAt,
	tags: entry.data.tags,
} : null;

if (!post) {
	return Astro.redirect('/blog');
}
---

<BaseLayout 
	title={`${post.title} - Blog Yến Sào Premium`}
	description={post.excerpt}
>
	<Header />
	<main class="min-h-screen py-8">
		<div class="container mx-auto px-4 max-w-4xl">
			<article class="bg-white rounded-lg shadow-md p-8">
				<div class="mb-6">
					<a href="/blog" class="text-amber-600 hover:underline mb-4 inline-block">
						← Quay lại danh sách
					</a>
					<h1 class="text-4xl font-bold text-gray-800 mb-4">{post.title}</h1>
					<div class="flex items-center gap-4 text-gray-600 text-sm mb-6">
						<span>Tác giả: {post.author}</span>
						<span>•</span>
						<span>{post.publishedAt.toLocaleDateString('vi-VN')}</span>
						{post.updatedAt && (
							<>
								<span>•</span>
								<span>Cập nhật: {post.updatedAt.toLocaleDateString('vi-VN')}</span>
							</>
						)}
					</div>
					<div id="admin-actions" class="flex gap-2 mb-6 hidden">
						<a href={`/blog/sua/${post.id}`} class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
							Sửa bài viết
						</a>
						<a 
							href={`/blog/xoa/${post.id}`}
							class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition"
						>
							Xóa bài viết
						</a>
					</div>
				</div>
				<div class="h-64 bg-amber-100 rounded-lg mb-6"></div>
				<article class="prose prose-lg max-w-none">
					<Content />
				</article>
				{post.tags && post.tags.length > 0 && (
					<div class="mt-8 pt-6 border-t border-gray-200">
						<div class="flex flex-wrap gap-2">
							{post.tags.map((tag) => (
								<span class="bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-sm">
									{tag}
								</span>
							))}
						</div>
					</div>
				)}
			</article>
		</div>
	</main>
	<Footer />
	<script>
		import { isAuthenticated } from '../../lib/auth';
		
		const adminActions = document.getElementById('admin-actions');
		if (adminActions && isAuthenticated()) {
			adminActions.classList.remove('hidden');
		}
	</script>
	<script type="application/ld+json" set:html={JSON.stringify({
		"@context": "https://schema.org",
		"@type": "BlogPosting",
		"headline": post.title,
		"description": post.excerpt,
		"image": `${siteURL}/images/blog/${post.slug}.jpg`,
		"datePublished": post.publishedAt.toISOString(),
		"dateModified": (post.updatedAt || post.publishedAt).toISOString(),
		"author": {
			"@type": "Person",
			"name": post.author
		},
		"publisher": {
			"@type": "Organization",
			"name": "Yến Sào Premium",
			"logo": {
				"@type": "ImageObject",
				"url": `${siteURL}/logo.png`
			}
		},
		"mainEntityOfPage": {
			"@type": "WebPage",
			"@id": `${siteURL}/blog/${post.slug}`
		},
		"keywords": post.tags?.join(", ") || ""
	})} />
	<script type="application/ld+json" set:html={JSON.stringify({
		"@context": "https://schema.org",
		"@type": "BreadcrumbList",
		"itemListElement": [
			{
				"@type": "ListItem",
				"position": 1,
				"name": "Trang chủ",
				"item": siteURL
			},
			{
				"@type": "ListItem",
				"position": 2,
				"name": "Blog",
				"item": `${siteURL}/blog`
			},
			{
				"@type": "ListItem",
				"position": 3,
				"name": post.title,
				"item": `${siteURL}/blog/${post.slug}`
			}
		]
	})} />
</BaseLayout>
