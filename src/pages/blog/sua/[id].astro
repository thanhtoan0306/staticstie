---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import { getPostById } from '../../../lib/blog';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
	const blogEntries = await getCollection('blog');
	return blogEntries.map((entry) => ({
		params: { id: entry.id },
	}));
}

const { id } = Astro.params;
const post = id ? await getPostById(id) : null;

if (!post) {
	return Astro.redirect('/blog');
}
---

<BaseLayout 
	title={`Sửa bài viết: ${post.title} - Blog Yến Sào Premium`}
	description="Chỉnh sửa bài viết"
>
	<Header />
	<main class="min-h-screen py-8">
		<div class="container mx-auto px-4 max-w-4xl">
			<h1 class="text-4xl font-bold mb-8 text-gray-800">Sửa bài viết</h1>
			<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
				<p class="text-blue-800 text-sm">
					<strong>Lưu ý:</strong> Sau khi chỉnh sửa và nhấn "Tải file Markdown", file mới sẽ được tải về. 
					Bạn cần thay thế file cũ trong thư mục <code class="bg-blue-100 px-1 rounded">src/content/blog/</code> 
					và chạy lại build.
				</p>
			</div>
			<form id="blog-form" class="bg-white rounded-lg shadow-md p-8">
				<input type="hidden" id="post-id" value={post.id} />
				<input type="hidden" id="old-slug" value={post.slug} />
				<div class="mb-6">
					<label class="block text-gray-700 font-semibold mb-2">Tiêu đề *</label>
					<input 
						type="text" 
						id="title"
						name="title"
						value={post.title}
						required
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-600"
					/>
				</div>
				<div class="mb-6">
					<label class="block text-gray-700 font-semibold mb-2">URL slug *</label>
					<input 
						type="text" 
						id="slug"
						name="slug"
						value={post.slug}
						required
						pattern="[a-z0-9-]+"
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-600"
					/>
				</div>
				<div class="mb-6">
					<label class="block text-gray-700 font-semibold mb-2">Tóm tắt *</label>
					<textarea 
						id="excerpt"
						name="excerpt"
						rows="3"
						required
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-600"
					>{post.excerpt}</textarea>
				</div>
				<div class="mb-6">
					<label class="block text-gray-700 font-semibold mb-2">Nội dung (Markdown) *</label>
					<textarea 
						id="content"
						name="content"
						rows="15"
						required
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-600 font-mono text-sm"
					>{post.content}</textarea>
				</div>
				<div class="mb-6">
					<label class="block text-gray-700 font-semibold mb-2">Tác giả *</label>
					<input 
						type="text" 
						id="author"
						name="author"
						value={post.author}
						required
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-600"
					/>
				</div>
				<div class="mb-6">
					<label class="block text-gray-700 font-semibold mb-2">Tags (phân cách bằng dấu phẩy)</label>
					<input 
						type="text" 
						id="tags"
						name="tags"
						value={post.tags?.join(', ') || ''}
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-600"
					/>
				</div>
				<div class="flex gap-4">
					<button 
						type="submit"
						class="bg-amber-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-amber-700 transition"
					>
						Tải file Markdown
					</button>
					<a 
						href={`/blog/${post.slug}`}
						class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-400 transition"
					>
						Hủy
					</a>
				</div>
			</form>
		</div>
	</main>
	<Footer />
	<script>
		import { isAuthenticated } from '../../../lib/auth';
		
		// Check authentication
		if (!isAuthenticated()) {
			window.location.href = `/login?return=${encodeURIComponent(window.location.pathname)}`;
		}
		
		const form = document.getElementById('blog-form');
		const oldSlug = document.getElementById('old-slug')?.getAttribute('value');

		form?.addEventListener('submit', (e) => {
			e.preventDefault();
			const formData = new FormData(form);
			const tags = formData.get('tags')?.toString().split(',').map(t => t.trim()).filter(t => t) || [];
			const title = formData.get('title')?.toString() || '';
			const slug = formData.get('slug')?.toString() || '';
			const excerpt = formData.get('excerpt')?.toString() || '';
			const content = formData.get('content')?.toString() || '';
			const author = formData.get('author')?.toString() || '';
			const updatedAt = new Date().toISOString().split('T')[0];
			
			// Get published date from original post (would need to pass it, but for now use today)
			const publishedAt = new Date().toISOString().split('T')[0];
			
			// Generate markdown content
			const frontmatter = `---
title: "${title.replace(/"/g, '\\"')}"
excerpt: "${excerpt.replace(/"/g, '\\"')}"
author: "${author.replace(/"/g, '\\"')}"
publishedAt: ${publishedAt}
updatedAt: ${updatedAt}
${tags.length > 0 ? `tags:\n${tags.map(t => `  - ${t}`).join('\n')}` : ''}
---

${content}`;

			// Create blob and download
			const blob = new Blob([frontmatter], { type: 'text/markdown' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = `${slug}.md`;
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(url);

			// Show instructions
			const message = oldSlug === slug 
				? `File ${slug}.md đã được tải về!\n\nBước tiếp theo:\n1. Thay thế file ${oldSlug}.md trong src/content/blog/\n2. Chạy npm run build\n3. Bài viết đã được cập nhật!`
				: `File ${slug}.md đã được tải về!\n\nBước tiếp theo:\n1. Xóa file ${oldSlug}.md cũ trong src/content/blog/\n2. Thêm file ${slug}.md mới vào src/content/blog/\n3. Chạy npm run build\n4. Bài viết đã được cập nhật!`;
			
			alert(message);
		});
	</script>
</BaseLayout>
